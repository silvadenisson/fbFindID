
# teste packages ads library

#devtools::install_github("facebookresearch/Radlibrary")

library(Radlibrary)
library(stringr)

token <- "EAAJBXQQtEAgBAHNbQpB4Q2urQGrCyC5NZBODbQGz1t8TfWpZBhkduDzCbpPFe6UBeRPqFnXRyPr5YwF2uKPZCb8t4nEVNMZBvwSH2ZCNXILDIeDa50iC5hUQ63WpyfVx2W0hgRU7aLuP76GfagECnDFS3EetFTyApw89npzcQrbU7i0vO6JaPBk7I3bKA4xzbZAt7Dt0VQHF3zjc7ZALPZCu"

#adlib_setup()
#adlib_set_longterm_token()

query <- adlib_build_query(ad_reached_countries = 'BR',
                           ad_active_status = 'ALL',
                           search_terms = "7 de setembro",
                           fields = "ad_data")

#response <- adlib_get(params = query, token = token)
result <- adlib_get(query, token_get())

results.tibble <- as_tibble(result, censor_access_token = TRUE)



query <- adlib_build_query(ad_reached_countries = 'BR',
                           ad_active_status = 'ALL',
                          # search_page_ids	= ""
                           search_terms = "7 de setembro",
                          #delivery_by_region = "Alagoas",
                           fields = "ad_data",
                          search_type = "KEYWORD_EXACT_PHRASE",
                           ad_type = c("POLITICAL_AND_ISSUE_ADS"))
result2 <- adlib_get(query, token_get())

results.tibble2 <- as_tibble(result2, censor_access_token = TRUE)

query <- adlib_build_query(ad_reached_countries = 'BR',
                           ad_active_status = 'ALL',
                           # search_page_ids	= ""
                           search_terms = "7 de setembro",
                           fields = "demographic_data",
                           ad_type = c("POLITICAL_AND_ISSUE_ADS"))

resultdemo <- adlib_get(query, token_get())

results.demmo <- as_tibble(resultdemo, censor_access_token = TRUE)


View(results.demmo[results.demmo$id == "764420618187492", ])

df1 <- results.demmo[results.demmo$id == "764420618187492", ]$demographic_distribution[[1]]

patriotas <- results.tibble2[str_detect(results.tibble2$ad_creative_bodies, "[b|B]olsonaro|[P|p]atriotas"),]



library(ggplot2)

ggplot(df1, aes(gender, percentage)) + geom_bar(stat = "sum")
ggplot(df1, aes(age, percentage)) + geom_bar(stat = "sum")

idade <- NULL
sexo <- NULL

for(i in 1:nrow(patriotas)){

  df1 <- results.demmo[results.demmo$id == patriotas$id[i], ]$demographic_distribution[[1]]

 if(!is.null(df1)){
   idade1 <- df1 %>%  group_by(age) %>%
     summarise(percent = sum(percentage))

   idade1$id <- results.demmo$id[i]
   idade1$page_name <- patriotas$page_name[i]

   sexo1 <- df1 %>%  group_by(gender) %>%
     summarise(percent = sum(percentage))

   sexo1$id <- results.demmo$id[i]
   sexo1$page_name <- patriotas$page_name[i]

   idade <- rbind(idade, idade1)
   sexo <- rbind(sexo, sexo1)
  }

}

ggplot(sexo, aes(page_name, percent)) + geom_boxplot() +
  coord_flip()#+ facet_wrap(~page_name)
ggplot(idade, aes(age, percent)) + geom_boxplot()

library(psych)


dsexo <- describeBy(sexo$percent, list(sexo$page_name, sexo$gender), mat = T)
didade <- describeBy(idade$percent, idade$age, mat = T)

ggplot(dsexo[dsexo$n. > 2, ], aes(group1, mean.)) + geom_bar(stat = "identity") +
  coord_flip() + facet_wrap(~group2)

result_paginated <- adlib_get_paginated(query, max_gets = 5, token)

df_paginated <- as_tibble(result_paginated)


library(ggplot2)
library(keyring)
library(dplyr)

results.tibble %>%
  group_by(page_name) %>%
  select(page_name) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  top_n(n = 20) %>%
  ggplot(aes(reorder(x = page_name, n), y = n)) +
  geom_bar(stat="identity") +
  xlab("Page Name") +
  ylab("Count of Ads") +
  theme_bw() +
  coord_flip() +
  labs(title = "Número de prograndas por páginas no Facebook",
       subtitle = "considerando o ultimos mil ads - termo de busca eleições \n- 11/08/2022 15h")



df_paginated %>%
  group_by(page_name) %>%
  select(page_name) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  top_n(n = 20) %>%
  ggplot(aes(reorder(x = page_name, n), y = n)) +
  geom_bar(stat="identity") +
  xlab("Page Name") +
  ylab("Count of Ads") +
  theme_bw() +
  coord_flip() +
  labs(title = "Número de prograndas por páginas no Facebook",
       subtitle = "considerando o ultimos 5 mil ads - termo de busca eleições \n- 11/08/2022 15h")



# o que divulgam em Alagoas e a quem buscam

query <- adlib_build_query(ad_reached_countries = 'BR',
                           ad_active_status = 'ALL',
                            search_page_ids	= "301774903545521",
                           search_terms = "eleições",
                           delivery_by_region = "Alagoas",
                           fields = "ad_data",
                          # search_type = "KEYWORD_EXACT_PHRASE",
                           ad_type = c("POLITICAL_AND_ISSUE_ADS"))

adsAlagoas <- adlib_get(query, token_get())

dfadsAlagoas <- as_tibble(adsAlagoas, censor_access_token = TRUE)

query <- adlib_build_query(ad_reached_countries = 'BR',
                           ad_active_status = 'ALL',
                            search_page_ids	= "301774903545521",
                            search_terms = "eleições",
                           #search_type = "KEYWORD_EXACT_PHRASE",
                           fields = "demographic_data",
                           ad_type = c("POLITICAL_AND_ISSUE_ADS"))


adsAlagoasDemo <- adlib_get(query, token_get())

df.adsAlagoasDemo <- as_tibble(adsAlagoasDemo, censor_access_token = TRUE)
df.adsAlagoasDemo$demographic_distribution


idade <- NULL
sexo <- NULL

for(i in 1:nrow(dfadsAlagoas)){

  df1 <- df.adsAlagoasDemo[df.adsAlagoasDemo$id == dfadsAlagoas$id[i], ]$demographic_distribution[[1]]

  if(!is.null(df1)){
    idade1 <- df1 %>%  group_by(age) %>%
      summarise(percent = sum(percentage))

    idade1$id <- results.demmo$id[i]
    idade1$page_name <- patriotas$page_name[i]

    sexo1 <- df1 %>%  group_by(gender) %>%
      summarise(percent = sum(percentage))

    sexo1$id <- results.demmo$id[i]
    sexo1$page_name <- patriotas$page_name[i]

    idade <- rbind(idade, idade1)
    sexo <- rbind(sexo, sexo1)
  }

}


ggplot(sexo, aes(page_name, percent)) + geom_boxplot() +
  coord_flip()#+ facet_wrap(~page_name)
ggplot(idade, aes(age, percent)) + geom_boxplot()



# regra para sete de setembro
# ((7 OR sete OR 07) AND (setembro OR set)) OR "7 9" OR "07 09" OR "7 09" OR "07 9" OR #7desetembrovaisergigante OR #dia7vaisergigante OR #dia07euvou OR #7desetembroeuvou OR #7set OR #7desetembro OR #dia07vaisergigante OR ((liberdade OR #liberdade OR pátria OR patriota OR patriotas OR independência OR #independencia OR transparência OR #transparencia OR bolsonaro OR #bolsonaro OR capitão OR #bolsonaronoprimeiroturno OR #capitaoeoterrordoladrao OR #bolsonaroreeleitoem2022 OR #bolsonaroreeleito2022 OR #direitaforte OR #liberdade OR #capitaodopovovaivencerdenovo OR #capitaonoprimeiroturno OR #capitaodopovo OR #ocapitaovaivenceroladrao OR #povonarua OR #capitaodopovoquevaivencerdenovo OR #bolsonarotemrazao OR #fechadocombolsonaro2022 OR #ptnuncamais OR #bolsonaroreeleitonoprimeiroturno OR #bolsonaroestacerto) AND (manifestação OR manifestações OR manifestante OR manifestantes OR atos OR ruas OR desfile OR desfiles))
